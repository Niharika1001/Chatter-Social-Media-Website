import React from 'react';
import { useLocation, Link } from 'react-router-dom';
import { CheckCircle, ArrowLeft, Download, Share2, Calendar, User, Brain } from 'lucide-react';
import { useAuth } from '../contexts/AuthContext';

const Result: React.FC = () => {
  const location = useLocation();
  const { getLastSuggestion } = useAuth();
  
  // Get suggestion from navigation state or fetch the last one
  const suggestion = location.state?.suggestion || getLastSuggestion();

  if (!suggestion) {
    return (
      <div className="max-w-4xl mx-auto">
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
          <Brain className="h-12 w-12 text-gray-400 mx-auto mb-4" />
          <h2 className="text-xl font-semibold text-gray-900 mb-2">No Career Suggestion Found</h2>
          <p className="text-gray-600 mb-6">
            You haven't received any career suggestions yet. Start by completing a qualification form.
          </p>
          <Link
            to="/"
            className="inline-flex items-center space-x-2 bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200"
          >
            <span>Get Started</span>
          </Link>
        </div>
      </div>
    );
  }

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const handleShare = async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'My Career Suggestion from CareerVice',
          text: 'Check out my personalized career advice!',
          url: window.location.href
        });
      } catch (error) {
        console.log('Error sharing:', error);
      }
    } else {
      // Fallback: copy to clipboard
      navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard!');
    }
  };

  const handleDownload = () => {
    const content = `
Career Suggestion Report
Generated by CareerVice AI

Date: ${formatDate(suggestion.createdAt)}
Level: ${suggestion.level}
Interests: ${suggestion.interests.join(', ')}
Strengths: ${suggestion.strengths.join(', ')}
Concerns: ${suggestion.fears.join(', ')}
${suggestion.fieldOfStudy ? `Field of Study: ${suggestion.fieldOfStudy}` : ''}
${suggestion.preferredJobType ? `Preferred Job Type: ${suggestion.preferredJobType}` : ''}

AI Career Advice:
${suggestion.aiResponse}

---
Generated by CareerVice - AI Career Advisor Platform
    `;

    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `career-suggestion-${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <Link
          to="/"
          className="flex items-center space-x-2 text-gray-600 hover:text-primary transition-colors duration-200"
        >
          <ArrowLeft className="h-5 w-5" />
          <span>Back to Home</span>
        </Link>
        
        <div className="flex items-center space-x-3">
          <button
            onClick={handleShare}
            className="flex items-center space-x-2 px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200"
          >
            <Share2 className="h-4 w-4" />
            <span>Share</span>
          </button>
          <button
            onClick={handleDownload}
            className="flex items-center space-x-2 px-4 py-2 text-sm bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
          >
            <Download className="h-4 w-4" />
            <span>Download</span>
          </button>
        </div>
      </div>

      {/* Success Banner */}
      <div className="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6">
        <div className="flex items-center space-x-3">
          <CheckCircle className="h-8 w-8 text-green-600" />
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Career Suggestion Generated!</h1>
            <p className="text-green-700 mt-1">Your personalized career advice is ready</p>
          </div>
        </div>
      </div>

      {/* Suggestion Metadata */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="flex items-center space-x-3">
            <Calendar className="h-5 w-5 text-primary" />
            <div>
              <p className="text-sm text-gray-600">Generated On</p>
              <p className="font-medium text-gray-900">{formatDate(suggestion.createdAt)}</p>
            </div>
          </div>
          <div className="flex items-center space-x-3">
            <User className="h-5 w-5 text-primary" />
            <div>
              <p className="text-sm text-gray-600">Education Level</p>
              <p className="font-medium text-gray-900 capitalize">{suggestion.level}</p>
            </div>
          </div>
          <div className="flex items-center space-x-3">
            <Brain className="h-5 w-5 text-primary" />
            <div>
              <p className="text-sm text-gray-600">AI Powered</p>
              <p className="font-medium text-gray-900">Career Analysis</p>
            </div>
          </div>
        </div>
      </div>

      {/* Input Summary */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 className="text-lg font-semibold text-gray-900 mb-4">Your Profile Summary</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 className="font-medium text-gray-900 mb-2">Interests</h3>
            <div className="flex flex-wrap gap-2">
              {suggestion.interests.map((interest, index) => (
                <span
                  key={index}
                  className="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full"
                >
                  {interest}
                </span>
              ))}
            </div>
          </div>
          <div>
            <h3 className="font-medium text-gray-900 mb-2">Strengths</h3>
            <div className="flex flex-wrap gap-2">
              {suggestion.strengths.map((strength, index) => (
                <span
                  key={index}
                  className="px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full"
                >
                  {strength}
                </span>
              ))}
            </div>
          </div>
          {suggestion.fears.length > 0 && (
            <div>
              <h3 className="font-medium text-gray-900 mb-2">Concerns</h3>
              <div className="flex flex-wrap gap-2">
                {suggestion.fears.map((fear, index) => (
                  <span
                    key={index}
                    className="px-3 py-1 bg-orange-100 text-orange-800 text-sm rounded-full"
                  >
                    {fear}
                  </span>
                ))}
              </div>
            </div>
          )}
          {suggestion.fieldOfStudy && (
            <div>
              <h3 className="font-medium text-gray-900 mb-2">Field of Study</h3>
              <p className="text-gray-700">{suggestion.fieldOfStudy}</p>
            </div>
          )}
        </div>
      </div>

      {/* AI Response */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div className="flex items-center space-x-2 mb-4">
          <Brain className="h-6 w-6 text-primary" />
          <h2 className="text-lg font-semibold text-gray-900">AI Career Advice</h2>
        </div>
        <div className="prose max-w-none">
          <div className="bg-gray-50 rounded-lg p-6 border-l-4 border-primary">
            <pre className="whitespace-pre-wrap font-sans text-gray-800 leading-relaxed">
              {suggestion.aiResponse}
            </pre>
          </div>
        </div>
      </div>

      {/* Next Steps */}
      <div className="bg-gradient-to-r from-primary to-blue-700 rounded-xl p-6 text-white">
        <h2 className="text-lg font-semibold mb-4">What's Next?</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <Link
            to="/profile"
            className="bg-white bg-opacity-20 rounded-lg p-4 hover:bg-opacity-30 transition-all duration-200"
          >
            <h3 className="font-medium mb-2">Complete Your Profile</h3>
            <p className="text-sm opacity-90">Add more details for better suggestions</p>
          </Link>
          <Link
            to="/suggestions"
            className="bg-white bg-opacity-20 rounded-lg p-4 hover:bg-opacity-30 transition-all duration-200"
          >
            <h3 className="font-medium mb-2">View All Suggestions</h3>
            <p className="text-sm opacity-90">See your career advice history</p>
          </Link>
        </div>
      </div>
    </div>
  );
};

export default Result;